<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings ‚Äì Zeitline</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .settings-header {
            margin-bottom: 2rem;
        }
        
        .settings-header h1 {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .settings-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .settings-section h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .settings-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .settings-row:first-of-type {
            padding-top: 0;
        }
        
        .setting-info h3 {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .setting-info p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .plan-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .plan-badge.free {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }
        
        .plan-badge.pro {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
        }
        
        .upgrade-card {
            background: linear-gradient(135deg, rgba(200, 255, 0, 0.1), rgba(0, 200, 150, 0.1));
            border: 1px solid var(--accent-primary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .upgrade-card h3 {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .upgrade-card p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }
        
        .upgrade-features {
            list-style: none;
            margin-bottom: 1.5rem;
        }
        
        .upgrade-features li {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            color: var(--text-secondary);
        }
        
        .upgrade-features li::before {
            content: '‚úì';
            color: var(--accent-secondary);
            font-weight: bold;
        }
        
        .price-tag {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 2rem;
        }
        
        .price-tag span {
            font-size: 1rem;
            color: var(--text-muted);
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 1rem;
            transition: color 0.2s;
        }
        
        .back-link:hover {
            color: var(--text-primary);
        }
        
        .danger-zone {
            border-color: var(--accent-tertiary);
        }
        
        .danger-zone h2 {
            color: var(--accent-tertiary);
        }
        
        .btn-danger {
            background: transparent;
            border: 1px solid var(--accent-tertiary);
            color: var(--accent-tertiary);
        }
        
        .btn-danger:hover {
            background: var(--accent-tertiary);
            color: var(--bg-primary);
        }
        
        .dev-settings {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.02));
        }
        
        .dev-settings h2 {
            color: #f59e0b;
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <a href="/dashboard.html" class="back-link" style="margin-bottom: 0;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Dashboard
            </a>
            <button class="btn btn-ghost" onclick="signOut()" style="color: var(--accent-tertiary);">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16 17 21 12 16 7"/>
                    <line x1="21" y1="12" x2="9" y2="12"/>
                </svg>
                Log out
            </button>
        </div>
        
        <div class="settings-header">
            <h1>Settings</h1>
            <p style="color: var(--text-muted);">Manage your account and preferences</p>
        </div>
        
        <!-- Account Section -->
        <div class="settings-section">
            <h2>üë§ Account</h2>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>Email</h3>
                    <p id="userEmail">user@example.com</p>
                </div>
            </div>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>Name</h3>
                    <p id="userName">User</p>
                </div>
                <button class="btn btn-ghost" onclick="window.location.href='/onboarding.html'">Edit Profile</button>
            </div>
        </div>
        
        <!-- Subscription Section -->
        <div class="settings-section">
            <h2>üí≥ Subscription</h2>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>Current Plan</h3>
                    <p>Your subscription status</p>
                </div>
                <span class="plan-badge free" id="planBadge">Free Plan</span>
            </div>
            
            <!-- Upgrade Card (shown for free users) -->
            <div class="upgrade-card" id="upgradeCard">
                <h3>Upgrade to Pro</h3>
                <p>Get the most out of Zeitline with advanced features.</p>
                
                <ul class="upgrade-features">
                    <li>Unlimited timeline history</li>
                    <li>AI-powered predictions</li>
                    <li>Advanced analytics & insights</li>
                    <li>Priority support</li>
                    <li>Data export</li>
                </ul>
                
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div class="price-tag">$20<span>/month</span></div>
                    <button class="btn btn-primary" onclick="handleUpgrade()">Upgrade Now</button>
                </div>
            </div>
            
            <!-- Manage Subscription (shown for pro users) -->
            <div id="manageSubscription" style="display: none; margin-top: 1rem;">
                <button class="btn btn-ghost" onclick="handleManageSubscription()">Manage Subscription</button>
            </div>
        </div>
        
        <!-- Calendar Integrations Section -->
        <div class="settings-section">
            <h2>üìÖ Calendar Integrations</h2>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 0.5rem;">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Google Calendar
                    </h3>
                    <p id="googleCalendarStatus">Sync your events from Google Calendar</p>
                </div>
                <button class="btn btn-secondary" id="googleCalendarBtn" onclick="handleGoogleCalendarConnect()">
                    Connect
                </button>
            </div>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 0.5rem;">
                            <path fill="#FF3B30" d="M19 4h-1V3c0-.55-.45-1-1-1s-1 .45-1 1v1H8V3c0-.55-.45-1-1-1s-1 .45-1 1v1H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>
                        </svg>
                        Apple Calendar
                    </h3>
                    <p id="appleCalendarStatus">Sync your events from iCloud Calendar</p>
                </div>
                <button class="btn btn-secondary" id="appleCalendarBtn" onclick="handleAppleCalendarConnect()">
                    Connect
                </button>
            </div>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>
                        <svg width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 0.5rem;">
                            <path fill="#0078D4" d="M21.5 4h-19C1.67 4 1 4.67 1 5.5v13c0 .83.67 1.5 1.5 1.5h19c.83 0 1.5-.67 1.5-1.5v-13c0-.83-.67-1.5-1.5-1.5zm0 14.5h-19V7.24l9.5 6.26 9.5-6.26v11.26zm-9.5-5.5L2.5 6.75V5.5h19v1.25L12 13z"/>
                        </svg>
                        Outlook Calendar
                    </h3>
                    <p id="outlookCalendarStatus">Sync your events from Microsoft Outlook</p>
                </div>
                <button class="btn btn-secondary" id="outlookCalendarBtn" onclick="handleOutlookCalendarConnect()">
                    Connect
                </button>
            </div>
            
            <div id="calendarSyncInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 12px;">
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                    <strong>Connected Calendars</strong>
                </p>
                <div id="connectedCalendarsList"></div>
                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.75rem;">
                    Last synced: <span id="lastSyncTime">Never</span>
                </p>
            </div>
        </div>
        
        <!-- Preferences Section -->
        <div class="settings-section">
            <h2>‚öôÔ∏è Preferences</h2>
            
            <div class="settings-row" style="flex-direction: column; align-items: stretch;">
                <div class="setting-info" style="margin-bottom: 0.75rem;">
                    <h3>üïê Timezone</h3>
                    <p>Select your timezone to correctly display calendar events</p>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <select id="timezoneSelect" style="flex: 1; padding: 0.5rem 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; cursor: pointer;">
                        <option value="America/New_York">Eastern Time (ET)</option>
                        <option value="America/Chicago">Central Time (CT)</option>
                        <option value="America/Denver">Mountain Time (MT)</option>
                        <option value="America/Los_Angeles">Pacific Time (PT)</option>
                        <option value="America/Anchorage">Alaska Time</option>
                        <option value="Pacific/Honolulu">Hawaii Time</option>
                        <option value="Europe/London">London (GMT/BST)</option>
                        <option value="Europe/Paris">Paris (CET)</option>
                        <option value="Europe/Berlin">Berlin (CET)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Asia/Shanghai">Shanghai (CST)</option>
                        <option value="Asia/Kolkata">India (IST)</option>
                        <option value="Asia/Dubai">Dubai (GST)</option>
                        <option value="Australia/Sydney">Sydney (AEST)</option>
                        <option value="Pacific/Auckland">Auckland (NZST)</option>
                    </select>
                    <button class="btn btn-primary" onclick="saveTimezone()" style="padding: 0.5rem 1rem;">Save</button>
                </div>
            </div>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>üíµ Currency</h3>
                    <p id="userCurrency">USD ($)</p>
                </div>
                <button class="btn btn-ghost" onclick="window.location.href='/onboarding.html'">Change</button>
            </div>
        </div>
        
        <!-- Danger Zone -->
        <div class="settings-section danger-zone">
            <h2>‚ö†Ô∏è Danger Zone</h2>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>Delete Account</h3>
                    <p>Permanently delete your account and all data</p>
                </div>
                <button class="btn btn-danger" onclick="handleDeleteAccount()">Delete Account</button>
            </div>
        </div>
        
        <!-- Developer Settings (localhost only) -->
        <div class="settings-section dev-settings" id="devSettings" style="display: none;">
            <h2>üõ†Ô∏è Developer Settings</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">
                These options are only visible on localhost for testing purposes.
            </p>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>Reset Onboarding</h3>
                    <p>Clear onboarding status and restart the onboarding flow</p>
                </div>
                <button class="btn btn-secondary" onclick="resetOnboarding()">Reset Onboarding</button>
            </div>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>Clear All Local Data</h3>
                    <p>Remove all Zeitline data from localStorage</p>
                </div>
                <button class="btn btn-secondary" onclick="clearAllLocalData()">Clear Data</button>
            </div>
            
            <div class="settings-row">
                <div class="setting-info">
                    <h3>View Local Storage</h3>
                    <p>Inspect the current localStorage data</p>
                </div>
                <button class="btn btn-ghost" onclick="toggleLocalStorageView()">View Data</button>
            </div>
            
            <div id="localStoragePreview" style="display: none; margin-top: 1rem;">
                <pre style="background: var(--bg-deep); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 1rem; font-size: 0.75rem; overflow: auto; max-height: 300px; color: var(--text-secondary);"></pre>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/js/firebase-config.js?v=3.0"></script>
    <script>
        function loadSettings(profile, firebaseUser = null) {
            // Get values from profile or Firebase user
            const fullName = profile?.personal?.fullName || (firebaseUser?.displayName) || null;
            const email = profile?.personal?.email || (firebaseUser?.email) || null;
            
            // Update UI with user data
            if (fullName) {
                document.getElementById('userName').textContent = fullName;
            }
            
            if (email) {
                document.getElementById('userEmail').textContent = email;
            }
            
            // Set timezone dropdown value
            if (profile?.personal?.timezone) {
                const timezoneSelect = document.getElementById('timezoneSelect');
                if (timezoneSelect) {
                    timezoneSelect.value = profile.personal.timezone;
                }
            }
            
            if (profile?.financial?.currency) {
                const currencyMap = {
                    'USD': 'USD ($)',
                    'EUR': 'EUR (‚Ç¨)',
                    'GBP': 'GBP (¬£)',
                    'CAD': 'CAD (C$)',
                    'AUD': 'AUD (A$)',
                    'INR': 'INR (‚Çπ)',
                    'JPY': 'JPY (¬•)'
                };
                document.getElementById('userCurrency').textContent = currencyMap[profile.financial.currency] || profile.financial.currency;
            }
            
            // Check plan status
            if (profile?.plan === 'pro') {
                document.getElementById('planBadge').textContent = 'Pro Plan';
                document.getElementById('planBadge').className = 'plan-badge pro';
                document.getElementById('upgradeCard').style.display = 'none';
                document.getElementById('manageSubscription').style.display = 'block';
            }
        }
        
        async function saveTimezone() {
            const timezoneSelect = document.getElementById('timezoneSelect');
            const timezone = timezoneSelect.value;
            
            try {
                // Update local storage
                const profile = localStorage.getItem('zeitline_profile');
                const data = profile ? JSON.parse(profile) : {};
                if (!data.personal) data.personal = {};
                data.personal.timezone = timezone;
                localStorage.setItem('zeitline_profile', JSON.stringify(data));
                
                // Try to save to server
                try {
                    await apiCall('/users/profile', {
                        method: 'PUT',
                        body: JSON.stringify({ personal: { timezone } })
                    });
                } catch (e) {
                    console.log('Could not save timezone to server, saved locally');
                }
                
                showSuccess('Timezone saved: ' + timezone);
            } catch (error) {
                console.error('Error saving timezone:', error);
                showError('Failed to save timezone');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Load from localStorage first
            const savedProfile = localStorage.getItem('zeitline_profile');
            if (savedProfile) {
                try {
                    loadSettings(JSON.parse(savedProfile), null);
                } catch (e) {
                    console.log('Could not load saved profile');
                }
            }
            
            // Also listen for auth state
            window.addEventListener('authStateChanged', async (e) => {
                const user = e.detail;
                if (user) {
                    // Load from local profile first, using Firebase user as fallback
                    const localProfile = localStorage.getItem('zeitline_profile');
                    const profile = localProfile ? JSON.parse(localProfile) : {};
                    loadSettings(profile, user);
                    
                    try {
                        const response = await apiCall('/users/profile');
                        if (response.data) {
                            loadSettings(response.data, user);
                        }
                    } catch (error) {
                        console.log('Could not load profile from API, using local data');
                    }
                }
            });
        });
        
        async function handleUpgrade() {
            try {
                showLoading('Redirecting to checkout...');
                
                const response = await apiCall('/stripe/create-checkout', {
                    method: 'POST',
                    body: JSON.stringify({
                        successUrl: window.location.origin + '/settings.html?upgraded=true',
                        cancelUrl: window.location.origin + '/settings.html'
                    })
                });
                
                if (response.data?.url) {
                    window.location.href = response.data.url;
                } else {
                    throw new Error('No checkout URL returned');
                }
            } catch (error) {
                hideLoading();
                console.error('Upgrade error:', error);
                alert('Checkout is not available in demo mode. This would redirect to Stripe in production.');
            }
        }
        
        async function handleManageSubscription() {
            alert('This would open the Stripe customer portal to manage your subscription.');
        }
        
        async function handleDeleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                if (confirm('This will permanently delete all your data. Type "DELETE" to confirm.')) {
                    // Clear local storage
                    localStorage.removeItem('zeitline_profile');
                    alert('Account deleted. Redirecting to home page...');
                    window.location.href = '/';
                }
            }
        }
        
        function showLoading(message) {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `<div class="loading-spinner"></div><p>${message}</p>`;
            document.body.appendChild(overlay);
        }
        
        function hideLoading() {
            const overlay = document.querySelector('.loading-overlay');
            if (overlay) overlay.remove();
        }
        
        // Check for upgrade success
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('upgraded') === 'true') {
            alert('üéâ Welcome to Pro! Your account has been upgraded.');
            window.history.replaceState({}, document.title, '/settings.html');
        }
        
        // Calendar Integration Functions
        async function initCalendarSettings() {
            // First load from localStorage for immediate display
            const profile = localStorage.getItem('zeitline_profile');
            if (profile) {
                try {
                    const data = JSON.parse(profile);
                    const integrations = data.integrations || {};
                    applyCalendarIntegrations(integrations);
                } catch (e) {
                    console.error('Error loading calendar settings from localStorage:', e);
                }
            }
            
            // Then fetch from API to get the real connection status
            try {
                const response = await apiCall('/calendars/list');
                if (response.success && response.data) {
                    const calendars = response.data;
                    console.log('Connected calendars from API:', calendars);
                    
                    // Update localStorage and UI based on API response
                    const profileData = profile ? JSON.parse(profile) : {};
                    if (!profileData.integrations) profileData.integrations = {};
                    
                    // Check each calendar type
                    const googleCal = calendars.find(c => c.type === 'google' || c.id === 'google');
                    const appleCal = calendars.find(c => c.type === 'apple' || c.id === 'apple');
                    const outlookCal = calendars.find(c => c.type === 'outlook' || c.id === 'outlook');
                    
                    if (googleCal) {
                        profileData.integrations.googleCalendar = {
                            connected: true,
                            email: googleCal.email || googleCal.calendars?.[0]?.name || '',
                            connectedAt: googleCal.connectedAt || new Date().toISOString()
                        };
                        updateCalendarButton('google', true, profileData.integrations.googleCalendar);
                    } else {
                        delete profileData.integrations.googleCalendar;
                        updateCalendarButton('google', false, null);
                    }
                    
                    if (appleCal) {
                        profileData.integrations.appleCalendar = {
                            connected: true,
                            account: appleCal.email || appleCal.appleId || '',
                            connectedAt: appleCal.connectedAt || new Date().toISOString()
                        };
                        updateCalendarButton('apple', true, profileData.integrations.appleCalendar);
                    } else {
                        delete profileData.integrations.appleCalendar;
                        updateCalendarButton('apple', false, null);
                    }
                    
                    if (outlookCal) {
                        profileData.integrations.outlookCalendar = {
                            connected: true,
                            email: outlookCal.email || '',
                            connectedAt: outlookCal.connectedAt || new Date().toISOString()
                        };
                        updateCalendarButton('outlook', true, profileData.integrations.outlookCalendar);
                    } else {
                        delete profileData.integrations.outlookCalendar;
                        updateCalendarButton('outlook', false, null);
                    }
                    
                    // Save updated integrations to localStorage
                    localStorage.setItem('zeitline_profile', JSON.stringify(profileData));
                    
                    // Update sync info
                    updateSyncInfo(profileData.integrations);
                }
            } catch (error) {
                console.log('Could not load calendars from API, using localStorage:', error);
            }
        }
        
        function applyCalendarIntegrations(integrations) {
            // Update Google Calendar UI
            if (integrations.googleCalendar?.connected) {
                updateCalendarButton('google', true, integrations.googleCalendar);
            }
            
            // Update Apple Calendar UI
            if (integrations.appleCalendar?.connected) {
                updateCalendarButton('apple', true, integrations.appleCalendar);
            }
            
            // Update Outlook Calendar UI
            if (integrations.outlookCalendar?.connected) {
                updateCalendarButton('outlook', true, integrations.outlookCalendar);
            }
            
            // Show sync info if any calendar is connected
            if (integrations.googleCalendar?.connected || integrations.appleCalendar?.connected || integrations.outlookCalendar?.connected) {
                updateSyncInfo(integrations);
            }
        }
        
        function updateCalendarButton(type, connected, calendarData) {
            const btn = document.getElementById(`${type}CalendarBtn`);
            const status = document.getElementById(`${type}CalendarStatus`);
            
            if (!btn || !status) return;
            
            if (connected) {
                btn.textContent = 'Disconnect';
                btn.className = 'btn btn-ghost';
                btn.style.color = 'var(--accent-tertiary)';
                
                const email = calendarData?.email || calendarData?.account || '';
                status.innerHTML = `<span style="color: var(--accent-secondary);">‚úì Connected</span>${email ? ` ‚Ä¢ ${email}` : ''}`;
            } else {
                btn.textContent = 'Connect';
                btn.className = 'btn btn-secondary';
                btn.style.color = '';
                
                const messages = {
                    google: 'Sync your events from Google Calendar',
                    apple: 'Sync your events from iCloud Calendar',
                    outlook: 'Sync your events from Microsoft Outlook'
                };
                status.textContent = messages[type] || 'Connect your calendar';
            }
        }
        
        function updateSyncInfo(integrations) {
            const syncInfo = document.getElementById('calendarSyncInfo');
            const calendarsList = document.getElementById('connectedCalendarsList');
            const lastSyncTime = document.getElementById('lastSyncTime');
            
            const calendars = [];
            if (integrations.googleCalendar?.connected) {
                calendars.push(`<span style="display: inline-flex; align-items: center; gap: 0.25rem; margin-right: 1rem;">
                    <span style="width: 8px; height: 8px; background: #34A853; border-radius: 50%;"></span>
                    Google Calendar
                </span>`);
            }
            if (integrations.appleCalendar?.connected) {
                calendars.push(`<span style="display: inline-flex; align-items: center; gap: 0.25rem; margin-right: 1rem;">
                    <span style="width: 8px; height: 8px; background: #FF3B30; border-radius: 50%;"></span>
                    Apple Calendar
                </span>`);
            }
            if (integrations.outlookCalendar?.connected) {
                calendars.push(`<span style="display: inline-flex; align-items: center; gap: 0.25rem;">
                    <span style="width: 8px; height: 8px; background: #0078D4; border-radius: 50%;"></span>
                    Outlook Calendar
                </span>`);
            }
            
            if (calendars.length > 0) {
                syncInfo.style.display = 'block';
                calendarsList.innerHTML = calendars.join('');
                
                // Get last sync time
                const lastSync = integrations.lastSync || integrations.googleCalendar?.connectedAt || integrations.appleCalendar?.connectedAt || integrations.outlookCalendar?.connectedAt;
                if (lastSync) {
                    lastSyncTime.textContent = new Date(lastSync).toLocaleString();
                }
            } else {
                syncInfo.style.display = 'none';
            }
        }
        
        async function handleGoogleCalendarConnect() {
            // First check if already connected via API
            let isConnected = false;
            try {
                const response = await apiCall('/calendars/list');
                if (response.success && response.data) {
                    const googleCal = response.data.find(c => c.type === 'google' || c.id === 'google');
                    isConnected = !!googleCal;
                }
            } catch (e) {
                // Fall back to localStorage
                const profile = localStorage.getItem('zeitline_profile');
                if (profile) {
                    const data = JSON.parse(profile);
                    isConnected = data.integrations?.googleCalendar?.connected;
                }
            }
            
            // Check if already connected
            if (isConnected) {
                if (confirm('Disconnect Google Calendar? Your calendar events will no longer sync.')) {
                    try {
                        showLoading('Disconnecting Google Calendar...');
                        await apiCall('/calendars/google/disconnect', { method: 'DELETE' });
                        
                        // Update localStorage
                        const profile = localStorage.getItem('zeitline_profile');
                        const data = profile ? JSON.parse(profile) : {};
                        if (data.integrations) {
                            delete data.integrations.googleCalendar;
                            localStorage.setItem('zeitline_profile', JSON.stringify(data));
                        }
                        
                        hideLoading();
                        updateCalendarButton('google', false, null);
                        updateSyncInfo(data.integrations || {});
                        showSuccess('Google Calendar disconnected');
                    } catch (error) {
                        hideLoading();
                        console.error('Error disconnecting:', error);
                        showError('Failed to disconnect Google Calendar');
                    }
                }
                return;
            }
            
            // Redirect to Google OAuth
            showLoading('Connecting to Google Calendar...');
            
            try {
                const response = await apiCall('/calendars/google/connect', { method: 'POST' });
                
                if (response.data?.authUrl) {
                    // Redirect to Google OAuth
                    window.location.href = response.data.authUrl;
                } else {
                    throw new Error('No auth URL returned');
                }
            } catch (error) {
                hideLoading();
                console.error('Google Calendar connection error:', error);
                showError('Failed to connect Google Calendar: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function handleAppleCalendarConnect() {
            const profile = localStorage.getItem('zeitline_profile');
            const data = profile ? JSON.parse(profile) : {};
            const integrations = data.integrations || {};
            
            // Check if already connected
            if (integrations.appleCalendar?.connected) {
                if (confirm('Disconnect Apple Calendar? Your calendar events will no longer sync.')) {
                    try {
                        showLoading('Disconnecting Apple Calendar...');
                        await apiCall('/calendars/apple/disconnect', { method: 'DELETE' });
                        
                        delete integrations.appleCalendar;
                        data.integrations = integrations;
                        localStorage.setItem('zeitline_profile', JSON.stringify(data));
                        
                        hideLoading();
                        updateCalendarButton('apple', false, null);
                        updateSyncInfo(integrations);
                        showSuccess('Apple Calendar disconnected');
                    } catch (error) {
                        hideLoading();
                        console.error('Error disconnecting:', error);
                        showError('Failed to disconnect Apple Calendar');
                    }
                }
                return;
            }
            
            // Show Apple Calendar connection modal
            showAppleCalendarModal();
        }
        
        function showAppleCalendarModal() {
            // Create modal if it doesn't exist
            let modal = document.getElementById('appleCalendarModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'appleCalendarModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                    <path fill="#FF3B30" d="M19 4h-1V3c0-.55-.45-1-1-1s-1 .45-1 1v1H8V3c0-.55-.45-1-1-1s-1 .45-1 1v1H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>
                                </svg>
                                Connect Apple Calendar
                            </h2>
                            <button class="modal-close" onclick="closeAppleCalendarModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
                                Apple Calendar requires an app-specific password for security. 
                                <a href="https://support.apple.com/en-us/102654" target="_blank" style="color: var(--accent-primary);">Learn how to create one ‚Üí</a>
                            </p>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Apple ID Email</label>
                                <input type="email" id="appleIdEmail" placeholder="your@icloud.com" 
                                    style="width: 100%; padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">App-Specific Password</label>
                                <input type="password" id="appleAppPassword" placeholder="xxxx-xxxx-xxxx-xxxx" 
                                    style="width: 100%; padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);">
                                <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">
                                    Generate at appleid.apple.com ‚Üí Security ‚Üí App-Specific Passwords
                                </p>
                            </div>
                            
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button class="btn btn-ghost" onclick="closeAppleCalendarModal()">Cancel</button>
                                <button class="btn btn-primary" onclick="submitAppleCalendarConnect()">Connect</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Add modal styles if not present
                if (!document.getElementById('modalStyles')) {
                    const style = document.createElement('style');
                    style.id = 'modalStyles';
                    style.textContent = `
                        .modal-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: rgba(0, 0, 0, 0.7);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 1000;
                            opacity: 0;
                            visibility: hidden;
                            transition: opacity 0.2s, visibility 0.2s;
                        }
                        .modal-overlay.active {
                            opacity: 1;
                            visibility: visible;
                        }
                        .modal-content {
                            background: var(--bg-card);
                            border: 1px solid var(--border-subtle);
                            border-radius: 16px;
                            padding: 1.5rem;
                            max-width: 90%;
                            max-height: 90vh;
                            overflow-y: auto;
                        }
                        .modal-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 1.5rem;
                        }
                        .modal-close {
                            background: none;
                            border: none;
                            font-size: 1.5rem;
                            color: var(--text-muted);
                            cursor: pointer;
                            padding: 0.25rem;
                        }
                        .modal-close:hover {
                            color: var(--text-primary);
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // Clear previous values
            document.getElementById('appleIdEmail').value = '';
            document.getElementById('appleAppPassword').value = '';
            
            modal.classList.add('active');
        }
        
        function closeAppleCalendarModal() {
            const modal = document.getElementById('appleCalendarModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        async function submitAppleCalendarConnect() {
            const email = document.getElementById('appleIdEmail').value.trim();
            const password = document.getElementById('appleAppPassword').value.trim();
            
            if (!email || !password) {
                showError('Please enter both Apple ID email and app-specific password');
                return;
            }
            
            closeAppleCalendarModal();
            showLoading('Connecting to Apple Calendar...');
            
            try {
                const response = await apiCall('/calendars/apple/connect', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                if (response.success) {
                    const profile = localStorage.getItem('zeitline_profile');
                    const data = profile ? JSON.parse(profile) : {};
                    const integrations = data.integrations || {};
                    
                    integrations.appleCalendar = {
                        connected: true,
                        account: email,
                        connectedAt: new Date().toISOString(),
                        method: 'caldav'
                    };
                    integrations.lastSync = new Date().toISOString();
                    
                    data.integrations = integrations;
                    localStorage.setItem('zeitline_profile', JSON.stringify(data));
                    
                    hideLoading();
                    updateCalendarButton('apple', true, integrations.appleCalendar);
                    updateSyncInfo(integrations);
                    showSuccess('Apple Calendar connected successfully!');
                } else {
                    throw new Error(response.error || 'Failed to connect');
                }
            } catch (error) {
                hideLoading();
                console.error('Apple Calendar connection error:', error);
                showError('Failed to connect Apple Calendar: ' + (error.message || 'Unknown error'));
            }
        }
        
        async function handleOutlookCalendarConnect() {
            const profile = localStorage.getItem('zeitline_profile');
            const data = profile ? JSON.parse(profile) : {};
            const integrations = data.integrations || {};
            
            // Check if already connected
            if (integrations.outlookCalendar?.connected) {
                if (confirm('Disconnect Outlook Calendar? Your calendar events will no longer sync.')) {
                    try {
                        showLoading('Disconnecting Outlook Calendar...');
                        await apiCall('/calendars/outlook/disconnect', { method: 'DELETE' });
                        
                        delete integrations.outlookCalendar;
                        data.integrations = integrations;
                        localStorage.setItem('zeitline_profile', JSON.stringify(data));
                        
                        hideLoading();
                        updateCalendarButton('outlook', false, null);
                        updateSyncInfo(integrations);
                        showSuccess('Outlook Calendar disconnected');
                    } catch (error) {
                        hideLoading();
                        console.error('Error disconnecting:', error);
                        showError('Failed to disconnect Outlook Calendar');
                    }
                }
                return;
            }
            
            // Redirect to Microsoft OAuth
            showLoading('Connecting to Outlook Calendar...');
            
            try {
                const response = await apiCall('/calendars/outlook/connect', { method: 'POST' });
                
                if (response.data?.authUrl) {
                    window.location.href = response.data.authUrl;
                } else {
                    throw new Error('No auth URL returned');
                }
            } catch (error) {
                hideLoading();
                console.error('Outlook Calendar connection error:', error);
                showError('Failed to connect Outlook Calendar: ' + (error.message || 'Unknown error'));
            }
        }
        
        function showError(message) {
            const existing = document.querySelector('.error-toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'error-toast';
            toast.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()">√ó</button>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Initialize calendar settings on load
        initCalendarSettings();
        
        // Developer Settings (localhost only)
        function initDevSettings() {
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1' ||
                               window.location.hostname === '';
            
            const devSettings = document.getElementById('devSettings');
            if (devSettings && isLocalhost) {
                devSettings.style.display = 'block';
            }
        }
        
        function resetOnboarding() {
            if (confirm('This will reset your onboarding status. You will be redirected to the onboarding flow. Continue?')) {
                localStorage.removeItem('zeitline_onboarding_complete');
                
                // Keep the profile data but mark onboarding as incomplete
                const profile = localStorage.getItem('zeitline_profile');
                if (profile) {
                    try {
                        const data = JSON.parse(profile);
                        data.onboardingComplete = false;
                        localStorage.setItem('zeitline_profile', JSON.stringify(data));
                    } catch (e) {
                        console.error('Error updating profile:', e);
                    }
                }
                
                showSuccess('Onboarding reset! Redirecting...');
                setTimeout(() => {
                    window.location.href = '/onboarding.html';
                }, 1000);
            }
        }
        
        function clearAllLocalData() {
            if (confirm('This will clear ALL Zeitline data from localStorage. This cannot be undone. Continue?')) {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('zeitline')) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                localStorage.removeItem('authToken');
                
                showSuccess('All local data cleared!');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }
        
        function toggleLocalStorageView() {
            const preview = document.getElementById('localStoragePreview');
            if (preview.style.display === 'none') {
                const data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        try {
                            data[key] = JSON.parse(localStorage.getItem(key));
                        } catch (e) {
                            data[key] = localStorage.getItem(key);
                        }
                    }
                }
                preview.querySelector('pre').textContent = JSON.stringify(data, null, 2);
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }
        
        function showSuccess(message) {
            const existing = document.querySelector('.success-toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.innerHTML = `<span>${message}</span><button onclick="this.parentElement.remove()">√ó</button>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Initialize dev settings on load
        initDevSettings();
    </script>
</body>
</html>





