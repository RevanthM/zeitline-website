<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äì Zeitline</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Dashboard specific styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.5rem;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-family: 'Instrument Serif', Georgia, serif;
            font-size: 2.5rem;
        }
        
        .stat-change {
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .stat-change.positive { color: var(--accent-secondary); }
        .stat-change.negative { color: var(--accent-tertiary); }
        
        .timeline-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .timeline-list {
            list-style: none;
        }
        
        .timeline-entry {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            transition: background 0.3s ease;
        }
        
        .timeline-entry:hover {
            background: var(--bg-elevated);
        }
        
        .entry-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .entry-icon.work { background: rgba(87, 255, 212, 0.15); }
        .entry-icon.rest { background: rgba(138, 43, 226, 0.15); }
        .entry-icon.exercise { background: rgba(255, 107, 107, 0.15); }
        .entry-icon.food { background: rgba(255, 165, 0, 0.15); }
        
        .entry-details {
            flex: 1;
        }
        
        .entry-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .entry-time {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .entry-duration {
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
        }
        
        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .prediction-card {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 1rem;
        }
        
        .prediction-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .prediction-activity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .prediction-confidence {
            font-size: 0.75rem;
            color: var(--accent-secondary);
            margin-top: 0.5rem;
        }
        
        .upgrade-banner {
            background: linear-gradient(135deg, rgba(201, 255, 87, 0.1), rgba(87, 255, 212, 0.1));
            border: 1px solid rgba(201, 255, 87, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .upgrade-text h3 {
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .upgrade-text p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .mobile-header {
            display: none;
            padding: 1rem;
            background: var(--bg-elevated);
            border-bottom: 1px solid var(--border-subtle);
            justify-content: space-between;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }
        }
        
        /* Activity Tracker Styles */
        .activity-tracker {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .sync-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: background 0.3s;
        }
        
        .sync-dot.connected {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }
        
        .active-session {
            background: linear-gradient(135deg, rgba(201, 255, 87, 0.1), rgba(87, 255, 212, 0.1));
            border: 1px solid rgba(201, 255, 87, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .active-session-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }
        
        .active-session-info {
            flex: 1;
        }
        
        .active-session-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .active-session-timer {
            font-family: 'DM Sans', monospace;
            font-size: 2rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            color: var(--accent-primary);
        }
        
        .active-session-device {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        .stop-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        
        .stop-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .activity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.75rem;
        }
        
        .activity-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-elevated);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .activity-btn:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }
        
        .activity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .activity-btn-icon {
            font-size: 1.5rem;
        }
        
        .activity-btn-name {
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
        }
        
        .no-session-msg {
            text-align: center;
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="/" class="logo">ZEITLINE</a>
            
            <nav class="sidebar-nav">
                <a href="/dashboard.html" class="nav-item active">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Dashboard
                </a>
                <a href="/timeline.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="2" x2="12" y2="22"/>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    Timeline
                </a>
                <a href="/calendar.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    Calendar
                </a>
                <a href="/recordings.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                    Recordings
                </a>
                <a href="/events.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                    Events & Tasks
                </a>
                <a href="/health-fitness.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    Health
                </a>
                <a href="/insights.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/>
                        <line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    Insights
                </a>
                <a href="/about-me.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    About Me
                </a>
                <a href="/settings.html" class="nav-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Settings
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn btn-ghost" style="width: 100%; justify-content: flex-start;" onclick="signOut()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Log out
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="dashboard-header">
                <h1>Welcome back, <span id="userName">User</span></h1>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">U</div>
                </div>
            </div>
            
            <!-- Upgrade Banner - Hidden, managed in Settings -->
            <div class="upgrade-banner" id="upgradeBanner" style="display: none;"></div>
            
            <!-- Activity Tracker - Start/Stop activities here -->
            <div class="activity-tracker">
                <div class="tracker-header">
                    <h2 style="font-size: 1.25rem; margin: 0;">Track Activity</h2>
                    <div class="sync-indicator">
                        <div class="sync-dot" id="syncDot"></div>
                        <span id="syncStatus">Connecting...</span>
                    </div>
                </div>
                
                <!-- Active Session Display -->
                <div id="activeSessionContainer">
                    <div class="no-session-msg" id="noSessionMsg">
                        Select an activity below to start tracking
                    </div>
                </div>
                
                <!-- Activity Buttons Grid -->
                <div class="activity-grid" id="activityGrid">
                    <!-- Activities will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Health Metrics from Apple Watch -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">üò¥ Sleep</div>
                    <div class="stat-value" id="dashSleep">--</div>
                    <div class="stat-change" id="dashSleepChange">Sync with Apple Watch</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üëü Steps</div>
                    <div class="stat-value" id="dashSteps">--</div>
                    <div class="stat-change" id="dashStepsChange">Sync with Apple Watch</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üî• Calories Burned</div>
                    <div class="stat-value" id="dashCaloriesBurnedTotal">--</div>
                    <div class="stat-change" id="dashCaloriesBurnedChange">Sync with Apple Watch</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">‚è±Ô∏è Active Minutes</div>
                    <div class="stat-value" id="dashActiveMinutes">--</div>
                    <div class="stat-change" id="dashActiveMinutesChange">Sync with Apple Watch</div>
                </div>
            </div>
            
            <!-- Nutrition & Fitness Summary -->
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                <!-- Nutrition Card -->
                <div class="stat-card" style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <div class="stat-label">üçΩÔ∏è Today's Nutrition</div>
                            <div class="stat-value" style="font-size: 2rem;" id="dashCaloriesEaten">0</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">/ <span id="dashCalorieGoal">2000</span> cal</div>
                        </div>
                        <a href="/nutrition.html" class="btn btn-ghost" style="padding: 0.25rem 0.5rem;">View ‚Üí</a>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Protein</div>
                            <div style="height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden;">
                                <div id="dashProteinBar" style="height: 100%; width: 0%; background: var(--accent-secondary); border-radius: 3px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Carbs</div>
                            <div style="height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden;">
                                <div id="dashCarbsBar" style="height: 100%; width: 0%; background: #5b8def; border-radius: 3px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Fat</div>
                            <div style="height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden;">
                                <div id="dashFatBar" style="height: 100%; width: 0%; background: #a855f7; border-radius: 3px; transition: width 0.5s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Exercise Card -->
                <div class="stat-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <div class="stat-label">üèÉ Exercise Today</div>
                            <div class="stat-value" style="font-size: 2rem; color: var(--accent-tertiary);" id="dashCaloriesBurned">0</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">calories burned</div>
                        </div>
                        <a href="/exercise.html" class="btn btn-ghost" style="padding: 0.25rem 0.5rem;">View ‚Üí</a>
                    </div>
                    <div style="display: flex; gap: 2rem; margin-top: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700;" id="dashExerciseDuration">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">minutes</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700;" id="dashExerciseCount">0</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">workouts</div>
                        </div>
                        <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end;">
                            <a href="/exercise.html" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.85rem;">+ Log</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Today's Timeline -->
            <div class="timeline-section">
                <h2 class="section-title">
                    Today's Timeline
                    <a href="/timeline.html" class="btn btn-ghost">View all ‚Üí</a>
                </h2>
                <ul class="timeline-list" id="timelineList">
                    <li class="timeline-entry">
                        <div class="entry-details" style="text-align: center; color: var(--text-muted); width: 100%;">
                            <div style="padding: 1rem;">Loading activities...</div>
                        </div>
                    </li>
                </ul>
            </div>
            
            <!-- Predictions (Pro feature) -->
            <div class="timeline-section" id="predictionsSection">
                <h2 class="section-title">
                    AI Predictions
                    <span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: var(--accent-primary); color: var(--bg-deep); border-radius: 100px; font-weight: 600;">PRO</span>
                </h2>
                <div class="predictions-grid">
                    <div class="prediction-card">
                        <div class="prediction-time">2:00 PM ‚Äì 3:00 PM</div>
                        <div class="prediction-activity">
                            <span>üíª</span>
                            <span>Afternoon Focus</span>
                        </div>
                        <div class="prediction-confidence">92% confidence</div>
                    </div>
                    <div class="prediction-card">
                        <div class="prediction-time">3:00 PM ‚Äì 3:15 PM</div>
                        <div class="prediction-activity">
                            <span>‚òï</span>
                            <span>Coffee Break</span>
                        </div>
                        <div class="prediction-confidence">88% confidence</div>
                    </div>
                    <div class="prediction-card">
                        <div class="prediction-time">5:30 PM ‚Äì 6:30 PM</div>
                        <div class="prediction-activity">
                            <span>üèãÔ∏è</span>
                            <span>Gym Session</span>
                        </div>
                        <div class="prediction-confidence">85% confidence</div>
                    </div>
                    <div class="prediction-card">
                        <div class="prediction-time">7:00 PM ‚Äì 8:00 PM</div>
                        <div class="prediction-activity">
                            <span>üçΩÔ∏è</span>
                            <span>Dinner</span>
                        </div>
                        <div class="prediction-confidence">95% confidence</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="/js/firebase-config.js?v=2.0"></script>
    <script src="/js/activity-manager.js"></script>
    <script>
        // Timer update interval
        let timerInterval = null;
        
        // Render activity buttons
        function renderActivityButtons() {
            const grid = document.getElementById('activityGrid');
            const hasActiveSession = !!activityManager.activeSession;
            
            grid.innerHTML = activityManager.defaultActivities.map(activity => `
                <button class="activity-btn" 
                        onclick="startActivity('${activity.name}', '${activity.icon}', '${activity.color}')"
                        ${hasActiveSession ? 'disabled' : ''}>
                    <span class="activity-btn-icon">${activity.icon}</span>
                    <span class="activity-btn-name">${activity.name}</span>
                </button>
            `).join('');
        }
        
        // Render active session
        function renderActiveSession(session) {
            const container = document.getElementById('activeSessionContainer');
            const noSessionMsg = document.getElementById('noSessionMsg');
            
            if (session) {
                const bgColor = activityManager.getColorValue(session.activityColor);
                const deviceLabel = session.deviceId === 'web' ? 'Started on Web' : 
                                   session.deviceId?.includes('-') ? 'Started on iPhone/Watch' : 
                                   `Started on ${session.deviceId}`;
                
                container.innerHTML = `
                    <div class="active-session">
                        <div class="active-session-icon" style="background: ${bgColor}20;">
                            ${session.activityIcon}
                        </div>
                        <div class="active-session-info">
                            <div class="active-session-name">${session.activityName}</div>
                            <div class="active-session-timer" id="sessionTimer">00:00</div>
                            <div class="active-session-device">${deviceLabel}</div>
                        </div>
                        <button class="stop-btn" onclick="stopActivity()">Stop</button>
                    </div>
                `;
                
                // Start timer updates
                startTimerUpdates();
            } else {
                container.innerHTML = `
                    <div class="no-session-msg">
                        Select an activity below to start tracking
                    </div>
                `;
                stopTimerUpdates();
            }
            
            // Update button states
            renderActivityButtons();
        }
        
        // Timer update loop
        function startTimerUpdates() {
            stopTimerUpdates();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function stopTimerUpdates() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        function updateTimer() {
            const timerEl = document.getElementById('sessionTimer');
            if (timerEl && activityManager.activeSession) {
                timerEl.textContent = activityManager.getActiveSessionElapsedFormatted();
            }
        }
        
        // Start an activity
        async function startActivity(name, icon, color) {
            try {
                await activityManager.startActivity(name, icon, color);
                // UI will update via the subscription callback
            } catch (error) {
                console.error('Failed to start activity:', error);
                alert('Failed to start activity: ' + error.message);
            }
        }
        
        // Stop the current activity
        async function stopActivity() {
            try {
                await activityManager.stopActivity();
                // UI will update via the subscription callback
            } catch (error) {
                console.error('Failed to stop activity:', error);
                alert('Failed to stop activity: ' + error.message);
            }
        }
        
        // Handle activities update from Firestore (real-time)
        function onActivitiesChanged(activities) {
            const dot = document.getElementById('syncDot');
            const status = document.getElementById('syncStatus');
            
            dot.classList.add('connected');
            status.textContent = 'Live ‚Ä¢ ' + new Date().toLocaleTimeString();
            
            // Update today's timeline with real data
            updateTodayTimeline(activities);
            
            // Update stats
            updateStats(activities);
        }
        
        // Handle active session change
        function onActiveSessionChanged(session) {
            renderActiveSession(session);
        }
        
        // Update today's timeline with real activities
        function updateTodayTimeline(activities) {
            const timelineList = document.getElementById('timelineList');
            const today = new Date().toDateString();
            
            // Filter to today's stopped activities
            const todayActivities = activities
                .filter(a => {
                    const activityDate = new Date(a.start_time).toDateString();
                    return activityDate === today && a.event_type === 'stopped';
                })
                .slice(0, 10);
            
            if (todayActivities.length === 0) {
                timelineList.innerHTML = `
                    <li class="timeline-entry">
                        <div class="entry-details" style="text-align: center; color: var(--text-muted);">
                            No completed activities today yet. Start tracking above!
                        </div>
                    </li>
                `;
                return;
            }
            
            timelineList.innerHTML = todayActivities.map(activity => {
                const startTime = new Date(activity.start_time);
                const endTime = new Date(activity.end_time);
                const duration = activity.duration || 0;
                
                const formatTime = (d) => d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                const formatDuration = (s) => {
                    const h = Math.floor(s / 3600);
                    const m = Math.floor((s % 3600) / 60);
                    return h > 0 ? `${h}h ${m}m` : `${m}m`;
                };
                
                const bgColor = activityManager.getColorValue(activity.activity_color);
                
                return `
                    <li class="timeline-entry">
                        <div class="entry-icon" style="background: ${bgColor}20;">${activity.activity_icon}</div>
                        <div class="entry-details">
                            <div class="entry-name">${activity.activity_name}</div>
                            <div class="entry-time">${formatTime(startTime)} ‚Äì ${formatTime(endTime)}</div>
                        </div>
                        <div class="entry-duration">${formatDuration(duration)}</div>
                    </li>
                `;
            }).join('');
        }
        
        // Update stats with real data
        function updateStats(activities) {
            const today = new Date().toDateString();
            const todayActivities = activities.filter(a => {
                const activityDate = new Date(a.start_time).toDateString();
                return activityDate === today && a.event_type === 'stopped';
            });
            
            // Count activities today
            const activityCount = todayActivities.length;
            
            // Total time tracked today
            const totalSeconds = todayActivities.reduce((sum, a) => sum + (a.duration || 0), 0);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const timeTracked = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            
            // Update stat cards
            const statCards = document.querySelectorAll('.stat-card');
            if (statCards[0]) {
                statCards[0].querySelector('.stat-value').textContent = activityCount;
            }
            if (statCards[1]) {
                statCards[1].querySelector('.stat-value').textContent = timeTracked || '0m';
            }
        }
        
        // Initialize activity tracking when authenticated
        function initActivityTracking() {
            renderActivityButtons();
            
            // Subscribe to real-time updates from Firestore
            activityManager.subscribeToActivities(
                onActivitiesChanged,
                onActiveSessionChanged
            );
        }
    </script>
    <script>
        // Dashboard functionality
        function loadDashboard(profile, firebaseUser = null) {
            // Try to get name from profile, then from Firebase user
            let fullName = profile?.personal?.fullName;
            let photoURL = profile?.personal?.photoURL;
            let email = profile?.personal?.email;
            
            // Fallback to Firebase user data
            if (firebaseUser) {
                fullName = fullName || firebaseUser.displayName;
                photoURL = photoURL || firebaseUser.photoURL;
                email = email || firebaseUser.email;
            }
            
            const firstName = fullName?.split(' ')[0] || 'User';
            document.getElementById('userName').textContent = firstName;
            
            const avatarEl = document.getElementById('userAvatar');
            if (photoURL) {
                avatarEl.innerHTML = `<img src="${photoURL}" alt="${firstName}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else {
                avatarEl.textContent = firstName.charAt(0).toUpperCase();
            }
            
            // Pro and Free have the same features for now
            // Upgrade option available in Settings
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check for saved profile in localStorage (demo mode)
            const savedProfile = localStorage.getItem('zeitline_profile');
            if (savedProfile) {
                try {
                    const profile = JSON.parse(savedProfile);
                    loadDashboard(profile);
                    return; // Don't wait for auth in demo mode
                } catch (e) {
                    console.log('Could not load saved profile');
                }
            }
            
            // Set timeout to show dashboard anyway if auth takes too long
            const authTimeout = setTimeout(() => {
                console.log('Auth timeout - showing dashboard in demo mode');
                loadDashboard({});
            }, 2000);
            
            window.addEventListener('authStateChanged', async (e) => {
                clearTimeout(authTimeout);
                const user = e.detail;
                
                if (!user) {
                    // Check if we have local data (demo mode)
                    const localProfile = localStorage.getItem('zeitline_profile');
                    if (localProfile) {
                        loadDashboard(JSON.parse(localProfile), null);
                        return;
                    }
                    window.location.href = '/login.html';
                    return;
                }
                
                // Load user profile from API
                try {
                    const response = await apiCall('/users/profile');
                    const profile = response.data;
                    
                    // Check if onboarding complete
                    if (!profile.onboardingComplete) {
                        window.location.href = '/onboarding.html';
                        return;
                    }
                    
                    loadDashboard(profile, user);
                    initActivityTracking();
                } catch (error) {
                    console.error('Error loading profile:', error);
                    // Fallback to local storage with Firebase user data
                    const localProfile = localStorage.getItem('zeitline_profile');
                    const profile = localProfile ? JSON.parse(localProfile) : {};
                    loadDashboard(profile, user);
                    initActivityTracking();
                }
            });
        });
        
        // Load nutrition and exercise data for dashboard
        function loadNutritionExerciseData(userId) {
            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0);
            const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
            
            // Default goals
            let nutritionGoals = { calories: 2000, protein: 50, carbs: 250, fat: 65 };
            
            // Load goals
            db.collection('users').doc(userId).get().then(doc => {
                if (doc.exists && doc.data().nutritionGoals) {
                    nutritionGoals = { ...nutritionGoals, ...doc.data().nutritionGoals };
                    document.getElementById('dashCalorieGoal').textContent = nutritionGoals.calories;
                }
            });
            
            // Listen to food entries
            db.collection('users').doc(userId)
                .collection('foodEntries')
                .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
                .onSnapshot(snapshot => {
                    const entries = snapshot.docs.map(doc => doc.data());
                    
                    const totals = entries.reduce((acc, entry) => {
                        const servings = entry.numberOfServings || 1;
                        return {
                            calories: acc.calories + (entry.calories || 0) * servings,
                            protein: acc.protein + (entry.protein || 0) * servings,
                            carbs: acc.carbs + (entry.carbs || 0) * servings,
                            fat: acc.fat + (entry.fat || 0) * servings
                        };
                    }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
                    
                    document.getElementById('dashCaloriesEaten').textContent = Math.round(totals.calories);
                    document.getElementById('dashProteinBar').style.width = Math.min(totals.protein / nutritionGoals.protein * 100, 100) + '%';
                    document.getElementById('dashCarbsBar').style.width = Math.min(totals.carbs / nutritionGoals.carbs * 100, 100) + '%';
                    document.getElementById('dashFatBar').style.width = Math.min(totals.fat / nutritionGoals.fat * 100, 100) + '%';
                });
            
            // Listen to exercise entries
            db.collection('users').doc(userId)
                .collection('exerciseEntries')
                .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
                .onSnapshot(snapshot => {
                    const entries = snapshot.docs.map(doc => doc.data());
                    
                    const totalCalories = entries.reduce((sum, e) => sum + (e.caloriesBurned || 0), 0);
                    const totalDuration = entries.reduce((sum, e) => sum + (e.duration || 0), 0);
                    
                    document.getElementById('dashCaloriesBurned').textContent = Math.round(totalCalories);
                    document.getElementById('dashExerciseDuration').textContent = Math.round(totalDuration);
                    document.getElementById('dashExerciseCount').textContent = entries.length;
                });
        }
        
        // Load health data from Apple Watch
        function loadHealthData(userId) {
            // Listen to today's health summary from Apple Watch
            db.collection('users').doc(userId)
                .collection('healthSummaries').doc('today')
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // Sleep
                        const sleepSeconds = data.sleepDuration || 0;
                        const sleepHours = Math.floor(sleepSeconds / 3600);
                        const sleepMinutes = Math.floor((sleepSeconds % 3600) / 60);
                        const sleepEl = document.getElementById('dashSleep');
                        const sleepChangeEl = document.getElementById('dashSleepChange');
                        if (sleepEl) {
                            sleepEl.textContent = sleepSeconds > 0 ? `${sleepHours}h ${sleepMinutes}m` : '--';
                        }
                        if (sleepChangeEl) {
                            if (sleepSeconds > 0) {
                                const goalHours = 8;
                                const diff = sleepHours - goalHours;
                                sleepChangeEl.textContent = diff >= 0 ? `‚úì Goal met (${goalHours}h)` : `${Math.abs(diff)}h below goal`;
                                sleepChangeEl.className = diff >= 0 ? 'stat-change positive' : 'stat-change';
                            }
                        }
                        
                        // Steps
                        const steps = data.steps || 0;
                        const stepsEl = document.getElementById('dashSteps');
                        const stepsChangeEl = document.getElementById('dashStepsChange');
                        if (stepsEl) {
                            stepsEl.textContent = steps > 0 ? steps.toLocaleString() : '--';
                        }
                        if (stepsChangeEl && steps > 0) {
                            const goal = 10000;
                            const percent = Math.round((steps / goal) * 100);
                            stepsChangeEl.textContent = percent >= 100 ? '‚úì Goal reached!' : `${percent}% of ${goal.toLocaleString()} goal`;
                            stepsChangeEl.className = percent >= 100 ? 'stat-change positive' : 'stat-change';
                        }
                        
                        // Calories Burned (from activity rings)
                        const rings = data.activityRings || {};
                        const caloriesBurned = rings.moveCalories || data.calories || 0;
                        const caloriesEl = document.getElementById('dashCaloriesBurnedTotal');
                        const caloriesChangeEl = document.getElementById('dashCaloriesBurnedChange');
                        if (caloriesEl) {
                            caloriesEl.textContent = caloriesBurned > 0 ? caloriesBurned.toLocaleString() : '--';
                        }
                        if (caloriesChangeEl && caloriesBurned > 0) {
                            const goal = rings.moveGoal || 600;
                            const percent = Math.round((caloriesBurned / goal) * 100);
                            caloriesChangeEl.textContent = percent >= 100 ? '‚úì Move goal complete!' : `${percent}% of ${goal} cal goal`;
                            caloriesChangeEl.className = percent >= 100 ? 'stat-change positive' : 'stat-change';
                        }
                        
                        // Active Minutes (exercise ring)
                        const activeMinutes = rings.exerciseMinutes || 0;
                        const activeEl = document.getElementById('dashActiveMinutes');
                        const activeChangeEl = document.getElementById('dashActiveMinutesChange');
                        if (activeEl) {
                            activeEl.textContent = activeMinutes > 0 ? `${activeMinutes}m` : '--';
                        }
                        if (activeChangeEl && activeMinutes > 0) {
                            const goal = rings.exerciseGoal || 30;
                            const percent = Math.round((activeMinutes / goal) * 100);
                            activeChangeEl.textContent = percent >= 100 ? '‚úì Exercise goal met!' : `${percent}% of ${goal}min goal`;
                            activeChangeEl.className = percent >= 100 ? 'stat-change positive' : 'stat-change';
                        }
                    } else {
                        // No health data - show prompts
                        const elements = ['dashSleep', 'dashSteps', 'dashCaloriesBurnedTotal', 'dashActiveMinutes'];
                        elements.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.textContent = '--';
                        });
                        const changeElements = ['dashSleepChange', 'dashStepsChange', 'dashCaloriesBurnedChange', 'dashActiveMinutesChange'];
                        changeElements.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) {
                                el.textContent = 'Sync Apple Watch to see data';
                                el.className = 'stat-change';
                            }
                        });
                    }
                }, error => {
                    console.error('Health data error:', error);
                });
        }
        
        // Call when auth is ready
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                loadNutritionExerciseData(user.uid);
                loadHealthData(user.uid);
            }
        });
        
    </script>
</body>
</html>

